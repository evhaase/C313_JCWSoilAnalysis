---
title: "ICPMS Data Analysis"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readr)
```

```{r ICPMS Data}
ICPMS <- read_csv("~/R/C313_JCWSoilAnalysis/Data/ICPMS_Data_Tidy.csv")
View(ICPMS)
```

```{r Defining lists}
sample_sites <- unique(filter(ICPMS, Site!="MB", Site!="")$Site)
#excluding method blank and quality control from the list of sites
metals_analyzed <- unique(ICPMS$metal)

#Preview the lists to check for potential issues
sample_sites
metals_analyzed
```

```{r Calibration}
#For loop
ICPMS_cal <- NULL
for (unique_metal in metals_analyzed){
  cal <- ICPMS %>%
    filter(Type== "Cal1" | Type== "Cal2" | Type== "Cal3") %>%
    filter(metal == unique_metal)%>%
    select(Concentration,CPS,RSD)
  
#Perform a weighted linear regression, account for uncertainty in the CPS by weighting the regression with the RSD readings  
  w <- 1/(cal$CPS*cal$RSD)^2
  model <- lm(cal$CPS ~ cal$Concentration, weights = w)
  
#Pulling info from model to be stored in a tidy calibration data set  
  slope <- model$coefficients[2]
  intercept <- model$coefficients[1]
  slope_std <- summary(model)$coefficients[2,2]
  intercept_std <- summary(model)$coefficients[1,2]
 
#Plot calibration curve   
  plot(cal$CPS ~ cal$Concentration,
       xlab= paste("Concentration of ", unique_metal, "(ppb)"), #units from the standard solution prepared at OHSU (µg/L)
       ylab= "Counts per second")+
       abline(model, col="red")+
       title(paste("Calibration for", unique_metal))
  equation <- tibble(metal= unique_metal, slope, slope_std, intercept, intercept_std)
  ICPMS_cal <- rbind(ICPMS_cal, equation)
}

ICPMS_cal
#Clearing the envrironment
remove(equation, cal, slope, slope_std, intercept, intercept_std, w, model, unique_metal)
```

```{r Creating a function for sample analysis}
#inputs: unique_site (as a character, ex. "A")
#outputs: concentration vector

sample_analysis <- function(unique_Site){
  concentration_data <- NULL
  for (unique_metal in metals_analyzed){
    sample <- filter(ICPMS, metal == unique_metal, Site == unique_Site)
    data <- NULL
    
    for(ID in sample$Sample.Key){
      sample_data <- filter(sample, Sample.Key == ID)
      cal <- filter(ICPMS_cal, metal == unique_metal)
      
      #sample analysis
      m <- cal$slope
      b <- cal$intercept
      y <- sample_data$CPS
      
      b_e <- cal$intercept_std
      m_e <- cal$slope_std
      
      x <- (y-b)/m #The units are dependent on the calibration standards (Kg/mL)
      
      rsd <- ((sample_data$RSD/100)*sample_data$CPS)
      cps <- sample_data$CPS
      
      #error propagation
      e_yb <- sqrt((rsd)^2 + (b_e)^2) 
      #error in the y-b from the calibration
      yb <- cps-b
      e_x <- x*sqrt((e_yb/yb)^2 + (m_e/m)^2)
      #error in x from the calibration
      
      data <- rbind(data, data_frame(Sample.Key = ID, x, e_x))
      if(unique_Site!= "MB"){
        concentration_data <- data_frame(Sample.Key = sample_data$Sample.Key,
                                         Analyst = sample_data$Analyst,
                                         metal = unique_metal,
                                         Site = unique_Site,
                                         conc_dil = x,
                                         conc_dil_error = e_x)%>%
          rbind(concentration_data)
      }
      if (unique_Site=="MB"){
        x <- mean(data$x)
        e_x <- sd(data$x)
        concentration_data <- data_frame(metal = unique_metal,
                                         Site = unique_Site,
                                         conc_dil = x,
                                         conc_dil_error = e_x) %>%
          rbind(concentration_data)
      }
    }
    return(concentration_data)
  }
}
```

```{r Creating a function for different soil sample sites}
#inputs: a function
#outputs: a data frame withe the function outputs from each site
run_sites <- function(Function){
  value <- NULL
  for(sites in sample_sites){
    site_value <- Function(sites)
    value <- rbind(site_value, value)
  }
  return(value)
}
```

```{r Analyze method blanks}
MB <- sample_analysis("MB") #(µg/kg)
uncor_sample <- run_sites(sample_analysis) #values do not account for dilutions (µg/kg)

MB
uncor_sample
```

```{r Corrections and error propagation}
sample_data_mb <- NULL

for (unique_metal in metals_analyzed){
  MB_metal <- filter(MB, metal==unique_metal)
  sample_metal <- filter(uncor_sample, metal==unique_metal)
  conc_dil_blanked <- sample_metal$conc_dil - MB_metal$conc_dil
  
  #Error propagation: subtraction of MB
  conc_dil_blanked_error <- sqrt((sample_metal$conc_dil_error)^2 + (MB_metal$conc_dil_error)^2)
  
  sample_data_mb <- sample_metal %>%
    mutate(conc_dil_blanked, conc_dil_blanked_error) %>%
    rbind(sample_data_mb)
}

sample_data_mb
```

#Sample Prep Procedures

1) mass_soil (ex. 1.50621) weighed on an analytical balance (uncertainty = ±0.001)
2) mass_soil was dried in 55 C oven for 1 week
3) mass_soil was ground with a mortar and pestle
4) mass_soil was quantitatively transferred to acid washed teflon beaker
5) mass_soil was digested with ~10 mL MQ water, 3 mL nitric acid, 2 mL hydrochloric acid and heated until steaming for 30 minutes
6) Acid digestion solution was quantitatively transferred to falcon tube and diluted to total_volume which was measured to fill line (ex, 45 mL)
7) Falcon tube centrifuged for 10 minutes at 1500 rpm for 10 minutes
8) 10 mL of sample transferred to metals-free 15 mL tube and brought to OHSU for ICPMS analysis. (stored in fridge prior to transport)
9) 10 µL (uncertainty= ± 1µL) of solution was micor-pipetted into 1000 µL (uncertainty) of MQ water by Lab Assistant at OHSU.

```{r Dilution factors and measurement errors}
#error propagation
vol_e <- 1
mass_e <- 0.001
dil_1010_e <- sqrt(1^2 + 10^2)
dil_e <- sqrt((dil_1010_e/1010)^2 + (1/10)^2) #error in 101 dilution factor

sample_data <- merge(ICPMS, sample_data_mb) %>% #This adds in important details such as soil mass
  unique()%>%
  mutate(conc_blanked= conc_dil_blanked*(Total.Volume/1000)/(Mass.of.Soil/1000)*101,
                                                             conc_blanked_error = conc_blanked*
      sqrt((conc_dil_blanked_error/conc_dil_blanked)^2+
             (dil_e/101)^2 +
             (mass_e/Mass.of.Soil)^2 +
             (vol_e/Total.Volume)^2),
      conc_unblanked = conc_dil*(Total.Volume/1000)/(Mass.of.Soil/1000)*101,
      conc_unblanked_error = conc_unblanked*
        sqrt((conc_dil_error/conc_dil)^2 +
               (dil_e/101)^2 +
               (mass_e/Mass.of.Soil)^2 +
               (vol_e/Total.Volume)^2)) %>%
select(-Concentration, #removing unnecessary columns
       -Type,
       -Mass.of.Soil,
       -Total.Volume,
       -CPS,
       -RSD,
       -conc_dil_blanked,
       -conc_dil_blanked_error,
       -conc_dil,
       -conc_dil_error)
```

```{r, warning= FALSE, Clean the Environment}
rm(list = ls()[!(ls() %in% c("ICPMS", "sample_data"))])
```
